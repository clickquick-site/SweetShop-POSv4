<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POS DZ - ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="bg-animated"></div>
<div class="page-wrapper">
  <header class="app-header">
    <button class="menu-btn" id="menuBtn" title="ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ">โฐ</button>
    <span class="store-name" id="headerStoreName">ุงุณู ุงููุชุฌุฑ</span>
    <!-- Bell injected by app.js via _injectBell() -->
    <div class="app-brand">
      <span class="brand-title">POS DZ</span>
      <span class="brand-clock" id="clockDisplay"></span>
    </div>
  </header>
  <div class="main-content">
    <div class="section-header">
      <a href="sale.html" class="back-btn">โ ุฑุฌูุน</a>
      <h2 class="page-title">๐ค ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</h2>
      <button class="btn btn-primary" onclick="openModal('addUserModal')">โ ุฅุถุงูุฉ ูุณุชุฎุฏู</button>
    </div>

    <div class="card" style="padding:0;overflow:hidden;">
      <table class="data-table">
        <thead><tr><th>ุงููุณุชุฎุฏู</th><th>ุงูุตูุงุญูุฉ</th><th>ุชุงุฑูุฎ ุงูุฅูุดุงุก</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
        <tbody id="usersTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal-overlay" id="addUserModal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <span class="modal-title" id="userModalTitle">โ ุฅุถุงูุฉ ูุณุชุฎุฏู</span>
      <button class="modal-close" onclick="closeModal('addUserModal')">โ</button>
    </div>
    <input type="hidden" id="editUserId"/>
    <div class="input-group">
      <label class="input-label">๐ค ุงุณู ุงููุณุชุฎุฏู *</label>
      <input class="input-field" type="text" id="userUsername" placeholder="ุงุณู ุงููุณุชุฎุฏู"/>
    </div>
    <div class="input-group">
      <label class="input-label">๐ ุงูุฑูู ุงูุณุฑู *</label>
      <input class="input-field" type="password" id="userPassword" placeholder="ุงูุฑูู ุงูุณุฑู"/>
    </div>
    <div class="input-group">
      <label class="input-label">๐ก๏ธ ุงูุตูุงุญูุฉ</label>
      <select class="select-field" id="userRole">
        <option value="seller">๐ค ุจุงุฆุน (ุตูุงุญูุงุช ูุญุฏูุฏุฉ)</option>
        <option value="manager">๐ก๏ธ ูุฏูุฑ ูุณุงุนุฏ (ูู ุงูุตูุงุญูุงุช)</option>
      </select>
    </div>
    <div id="userRoleInfo" class="alert alert-info text-sm" style="margin-top:8px;"></div>
    <div class="modal-footer">
      <button class="btn btn-success" onclick="saveUser()">๐พ ุญูุธ</button>
      <button class="btn btn-secondary" onclick="closeModal('addUserModal')">ุฅูุบุงุก</button>
    </div>
  </div>
</div>

<!-- Change Admin Password Modal -->
<div class="modal-overlay" id="adminPassModal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <span class="modal-title">๐ ุชุบููุฑ ูููุฉ ูุฑูุฑ ADMIN</span>
      <button class="modal-close" onclick="closeModal('adminPassModal')">โ</button>
    </div>
    <div class="input-group">
      <label class="input-label">ุงูุฑูู ุงูุณุฑู ุงูุญุงูู</label>
      <input class="input-field" type="password" id="oldPass" placeholder="ุงูุฑูู ุงูุญุงูู"/>
    </div>
    <div class="input-group">
      <label class="input-label">ุงูุฑูู ุงูุณุฑู ุงูุฌุฏูุฏ</label>
      <input class="input-field" type="password" id="newPass" placeholder="ุงูุฑูู ุงูุฌุฏูุฏ"/>
    </div>
    <div class="modal-footer">
      <button class="btn btn-success" onclick="changeAdminPass()">๐พ ุชุบููุฑ</button>
      <button class="btn btn-secondary" onclick="closeModal('adminPassModal')">ุฅูุบุงุก</button>
    </div>
  </div>
</div>

<!-- Sidebar โ labels only, no icons -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-brand">POS DZ</div>
    <div class="sidebar-user" id="sidebarUser"></div>
  </div>
  <nav class="sidebar-nav">
    <a class="nav-item" href="sale.html">
      <span class="nav-label" data-nav="navSale">ูุงุฌูุฉ ุงูุจูุน</span>
    </a>
    <a class="nav-item" href="inventory.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navInventory">ุฅุฏุงุฑุฉ ุงููุฎุฒูู</span>
    </a>
    <a class="nav-item" href="customers.html" data-role="admin,manager,seller">
      <span class="nav-label" data-nav="navCustomers">ุฅุฏุงุฑุฉ ุงูุฒุจุงุฆู</span>
    </a>
    <a class="nav-item" href="reports.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navReports">ุฅุฏุงุฑุฉ ุงูุฃุนูุงู</span>
    </a>
    <a class="nav-item" href="users.html" data-role="admin">
      <span class="nav-label" data-nav="navUsers">ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</span>
    </a>
    <a class="nav-item" href="suppliers.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navSuppliers">ุฅุฏุงุฑุฉ ุงูููุฒุนูู</span>
    </a>
    <a class="nav-item" href="settings.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navSettings">ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ</span>
    </a>
    <div class="nav-item danger" onclick="doLogout()">
      <span class="nav-label" data-nav="navLogout">ุฅุบูุงู ุงูุชุทุจูู</span>
    </div>
  </nav>
  <div class="sidebar-footer">POS DZ v6.0.0 | 2026 ุจูุณ ุฏูุฒุงุฏ ยฎ</div>
</div>
<div id="toast-container"></div>
<script src="app.js"></script>
<script>
const ROLE_LABELS = { admin: '๐ ูุฏูุฑ ุฑุฆูุณู', manager: '๐ก๏ธ ูุฏูุฑ ูุณุงุนุฏ', seller: '๐ค ุจุงุฆุน' };
const ROLE_PERMS = {
  manager: 'ูู ุงูุตูุงุญูุงุช: ุงูุจูุนุ ุงููุฎุฒููุ ุงูุฒุจุงุฆูุ ุงูุฃุนูุงูุ ุงูููุฒุนููุ ุงูุฅุนุฏุงุฏุงุช',
  seller: 'ุงูุจูุน ููุท + ุงูุงุทูุงุน ุนูู ุงูุฏููู + ูุจูู ุฏููู ููุฒุจุงุฆู ุงููุณุฌููู'
};

async function init() {
  requireRole(['admin']);
  await initApp();
  loadUsers();
  document.getElementById('userRole').addEventListener('change', function() {
    document.getElementById('userRoleInfo').textContent = ROLE_PERMS[this.value] || '';
  });
  document.getElementById('userRoleInfo').textContent = ROLE_PERMS['seller'];
}

async function loadUsers() {
  const users = await dbGetAll('users');
  const currentUser = getSession();
  const tbody = document.getElementById('usersTbody');
  tbody.innerHTML = users.map(u => {
    const isAdmin = u.role === 'admin';
    const actions = isAdmin
      ? `<button class="btn btn-sm btn-warning" onclick="openModal('adminPassModal')">๐ ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</button>`
      : `<button class="btn btn-sm btn-primary" onclick="editUser(${u.id})">โ๏ธ</button>
         <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">๐๏ธ</button>`;
    return `<tr>
      <td><b>${u.username}</b></td>
      <td><span class="badge ${u.role==='admin'?'badge-primary':u.role==='manager'?'badge-info':'badge-success'}">${ROLE_LABELS[u.role]||u.role}</span></td>
      <td>${formatDate(u.createdAt)}</td>
      <td class="actions">${actions}</td>
    </tr>`;
  }).join('');
}

async function saveUser() {
  const id = document.getElementById('editUserId').value;
  const username = document.getElementById('userUsername').value.trim();
  const password = document.getElementById('userPassword').value.trim();
  const role = document.getElementById('userRole').value;
  if (!username) { toast('ุงุณู ุงููุณุชุฎุฏู ูุทููุจ', 'warning'); return; }
  const data = { username, role, createdAt: new Date().toISOString() };
  if (password) data.password = hashPassword(password);
  if (id) {
    const existing = await dbGet('users', parseInt(id));
    data.id = parseInt(id);
    if (!password) data.password = existing.password;
    await dbPut('users', data);
    toast('ุชู ุงูุชุนุฏูู โ', 'success');
  } else {
    if (!password) { toast('ุงูุฑูู ุงูุณุฑู ูุทููุจ', 'warning'); return; }
    data.password = hashPassword(password);
    await dbAdd('users', data);
    toast('ุชูุช ุงูุฅุถุงูุฉ โ', 'success');
  }
  closeModal('addUserModal');
  clearUserForm();
  loadUsers();
}

async function editUser(id) {
  const u = await dbGet('users', id);
  document.getElementById('editUserId').value = u.id;
  document.getElementById('userUsername').value = u.username;
  document.getElementById('userPassword').value = '';
  document.getElementById('userRole').value = u.role;
  document.getElementById('userRoleInfo').textContent = ROLE_PERMS[u.role] || '';
  document.getElementById('userModalTitle').textContent = 'โ๏ธ ุชุนุฏูู ุงููุณุชุฎุฏู';
  openModal('addUserModal');
}

async function deleteUser(id) {
  const u = await dbGet('users', id);
  if (u.role === 'admin') { toast('ูุง ูููู ุญุฐู ุงููุฏูุฑ ุงูุฑุฆูุณู', 'error'); return; }
  const _ok = await customConfirmAsync('ุญุฐู ูุฐุง ุงููุณุชุฎุฏูุ');
  if (!_ok) return;
  await dbDelete('users', id);
  toast('ุชู ุงูุญุฐู', 'success');
  loadUsers();
}

async function changeAdminPass() {
  const oldPass = document.getElementById('oldPass').value;
  const newPass = document.getElementById('newPass').value;
  if (!oldPass || !newPass) { toast('ูุฑุฌู ููุก ุงูุญููู', 'warning'); return; }
  const users = await dbGetAll('users');
  const admin = users.find(u => u.role === 'admin');
  if (admin.password !== hashPassword(oldPass)) { toast('ุงูุฑูู ุงูุณุฑู ุงูุญุงูู ุบูุฑ ุตุญูุญ', 'error'); return; }
  admin.password = hashPassword(newPass);
  await dbPut('users', admin);
  toast('ุชู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ โ', 'success');
  try { notifPasswordChange(admin.username); } catch(e) {}
  closeModal('adminPassModal');
}

function clearUserForm() {
  document.getElementById('editUserId').value = '';
  document.getElementById('userUsername').value = '';
  document.getElementById('userPassword').value = '';
  document.getElementById('userRole').value = 'seller';
  document.getElementById('userModalTitle').textContent = 'โ ุฅุถุงูุฉ ูุณุชุฎุฏู';
}

function doLogout() { customConfirm('ูู ุชุฑูุฏ ุชุณุฌูู ุงูุฎุฑูุฌุ', () => { clearSession(); window.location.href = 'index.html'; }); }
init();
</script>
</body>
</html>
