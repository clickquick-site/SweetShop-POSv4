<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POS DZ - ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    body { overflow: hidden; }
    .sale-layout { display: flex; flex-direction: column; height: 100vh; }
    .sale-body   { flex: 1; display: flex; flex-direction: column; padding: 10px 12px; gap: 7px; overflow: hidden; }

    /* Search */
    .search-wrap  { position: relative; }
    .search-bar   { margin-bottom: 0; }
    .search-bar input { font-size: 1rem; font-weight: 700; }

    /* Cart area */
    .cart-area {
      flex: 1; overflow-y: auto; overflow-x: auto;
      background: var(--bg-medium);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      position: relative;
    }

    /* POS DZ watermark */
    .cart-area::before {
      content: 'POS DZ';
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      font-family: Impact, sans-serif;
      font-size: clamp(3.5rem, 15vw, 8rem);
      font-weight: 900;
      color: rgba(124,58,237,0.055);
      letter-spacing: 8px;
      pointer-events: none; user-select: none; z-index: 0;
    }
    .cart-area > * { position: relative; z-index: 1; }

    /* Cart header */
    .cart-header-row {
      display: grid;
      grid-template-columns: minmax(170px,1fr) 120px 90px 44px;
      gap: 6px; padding: 9px 12px;
      background: var(--bg-dark);
      border-bottom: 2px solid var(--primary);
      font-size: 0.82rem; color: var(--text-secondary); font-weight: 800;
      min-width: 440px;
      position: sticky; top: 0; z-index: 2;
      letter-spacing: 0.2px;
    }

    /* Cart item row */
    .cart-item-row {
      display: grid;
      grid-template-columns: minmax(170px,1fr) 120px 90px 44px;
      gap: 6px; padding: 8px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      align-items: center;
      transition: background 0.14s;
      min-width: 440px;
    }
    .cart-item-row:hover { background: rgba(124,58,237,0.07); }
    .cart-item-row:nth-child(even) { background: rgba(255,255,255,0.016); }

    /* Product cell */
    .cart-name-cell { display: flex; flex-direction: column; gap: 3px; }
    .cart-name-text { font-size: 0.96rem; font-weight: 700; color: var(--text-primary); line-height: 1.3; }
    .cart-type-badge {
      display: inline-block; font-size: 0.7rem; font-weight: 700;
      background: rgba(124,58,237,0.14); color: var(--primary-light);
      border: 1px solid rgba(124,58,237,0.28);
      border-radius: 5px; padding: 1px 7px; width: fit-content;
    }

    /* Qty control â€” âˆ’ [ 00 ] + */
    .cart-qty-ctrl {
      display: flex; align-items: center; justify-content: center;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm); overflow: hidden;
    }
    .cqc-btn {
      background: transparent; border: none;
      color: var(--text-primary);
      padding: 5px 10px; cursor: pointer;
      font-size: 1rem; font-weight: 800;
      transition: background 0.12s; line-height: 1;
      min-width: 30px;
    }
    .cqc-btn:hover { background: var(--primary); color: #fff; }
    .cqc-btn.minus:hover { background: var(--danger); color: #fff; }
    .cqc-val {
      border-right: 1px solid var(--border);
      border-left:  1px solid var(--border);
      padding: 5px 8px; font-weight: 800;
      min-width: 36px; text-align: center;
      font-size: 0.92rem; background: transparent;
      border-top: none; border-bottom: none;
      color: var(--text-primary); outline: none;
      font-family: 'Cairo', sans-serif;
    }
    .cqc-val:focus { background: var(--bg-card); }

    /* Total cell */
    .total-cell {
      color: var(--primary-light); font-weight: 900;
      font-size: 1rem; text-align: center;
    }
    .del-btn {
      background: transparent; border: none;
      color: var(--danger); font-size: 1rem;
      cursor: pointer; padding: 5px 8px;
      border-radius: 5px; transition: background 0.13s;
      font-weight: 700;
    }
    .del-btn:hover { background: rgba(239,68,68,0.15); }

    /* Bottom bar */
    .cart-bottom-bar {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-sm); padding: 8px 14px;
      flex-wrap: wrap;
    }
    .cbb-count {
      background: rgba(124,58,237,0.14); border: 1px solid rgba(124,58,237,0.28);
      color: var(--primary-light); font-size: 0.86rem; font-weight: 800;
      padding: 4px 13px; border-radius: 20px; white-space: nowrap;
    }
    .cbb-disc { display: flex; align-items: center; gap: 6px; flex: 1; min-width: 200px; }
    .cbb-disc label { font-size: 0.84rem; color: var(--text-secondary); white-space: nowrap; font-weight: 700; }
    .cbb-disc input {
      width: 90px; background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text-primary); padding: 5px 8px;
      font-family: 'Cairo', sans-serif; font-size: 0.92rem; font-weight: 700;
      outline: none; text-align: center;
    }
    .cbb-disc input:focus { border-color: var(--primary); }
    .cbb-total {
      display: flex; flex-direction: column; align-items: flex-end; margin-right: auto;
    }
    .cbb-total-label { font-size: 0.7rem; color: var(--text-secondary); font-weight: 700; letter-spacing: 0.2px; }
    .cbb-total-amount {
      font-family: Impact, sans-serif; font-size: 2.1rem;
      color: var(--primary-light); text-shadow: 0 0 12px var(--glow); line-height: 1;
    }
    .cbb-disc-badge { font-size: 0.7rem; color: var(--warning); font-weight: 700; }

    /* Debt row */
    .debt-row {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-sm); padding: 8px 14px; flex-wrap: wrap;
    }
    .debt-row label { font-size: 0.84rem; color: var(--text-secondary); white-space: nowrap; font-weight: 700; }
    .debt-row input {
      width: 110px; background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text-primary); padding: 6px 10px;
      font-family: 'Cairo', sans-serif; font-size: 0.92rem; font-weight: 700;
      outline: none; text-align: center;
    }
    .debt-row input:focus { border-color: var(--primary); }
    .customer-select-wrap { flex: 1; min-width: 150px; max-width: 230px; position: relative; }
    .customer-select-wrap select {
      width: 100%; background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text-primary); padding: 6px 10px;
      font-family: 'Cairo', sans-serif; font-size: 0.92rem; font-weight: 600;
      outline: none; appearance: none; -webkit-appearance: none;
    }
    .customer-select-wrap select:focus { border-color: var(--primary); }
    .customer-select-wrap::after {
      content: 'â–¼'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
      color: var(--text-secondary); font-size: 0.65rem; pointer-events: none;
    }

    /* Action buttons â€” text only, no icons */
    .action-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .action-btns .btn {
      font-size: 1rem; font-weight: 800; padding: 13px 10px;
      border-radius: var(--radius); letter-spacing: 0.3px;
    }

    /* VKB Toggle */
    .vkb-toggle {
      position: fixed; bottom: 80px; left: 0;
      background: var(--primary); color: #fff;
      border: none; border-radius: 0 8px 8px 0;
      padding: 10px 8px; cursor: pointer;
      writing-mode: vertical-rl; font-size: 0.78rem;
      font-family: 'Cairo', sans-serif; font-weight: 700;
      z-index: 400; box-shadow: 2px 0 12px rgba(0,0,0,0.3);
      transition: var(--transition); letter-spacing: 1px;
    }
    .vkb-toggle:hover { background: var(--primary-dark); padding-left: 12px; }
    .vkb-panel {
      position: fixed; bottom: 20px; left: 20px;
      z-index: 450; display: none;
      background: var(--bg-dark); border: 1px solid var(--primary);
      border-radius: var(--radius);
      box-shadow: 0 8px 32px rgba(0,0,0,0.55);
      cursor: move; user-select: none;
    }
    .vkb-panel.open { display: block; }
    .vkb-panel-header {
      background: var(--bg-medium); padding: 8px 12px;
      display: flex; justify-content: space-between; align-items: center;
      border-radius: var(--radius) var(--radius) 0 0;
      font-size: 0.82rem; color: var(--text-secondary);
    }
    .vkb-panel-close { background:none;border:none;color:var(--danger);cursor:pointer;font-size:1rem; }
  </style>
</head>
<body>
<div class="bg-animated"></div>
<div class="sale-layout">
  <!-- Header: â˜° | Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± | ğŸ”” | POS DZ -->
  <header class="app-header">
    <button class="menu-btn" id="menuBtn" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">â˜°</button>
    <span class="store-name" id="headerStoreName">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</span>
    <!-- Bell injected by app.js -->
    <div class="app-brand">
      <span class="brand-title">POS DZ</span>
      <span class="brand-clock" id="clockDisplay"></span>
    </div>
  </header>

  <div class="sale-body">
    <!-- Search -->
    <div class="search-wrap">
      <div class="search-bar">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="searchInput"
          placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯..."
          autocomplete="off"/>
        <span class="search-icon">ğŸ“·</span>
      </div>
      <div class="autocomplete-list" id="autocompleteList"></div>
    </div>

    <!-- Cart -->
    <div class="cart-area" id="cartArea">
      <div class="cart-header-row">
        <span>Ø§Ù„Ù…Ù†ØªØ¬</span>
        <span style="text-align:center;">Ø§Ù„ÙƒÙ…ÙŠØ©</span>
        <span style="text-align:center;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</span>
        <span style="text-align:center;">Ø­Ø°Ù</span>
      </div>
      <div id="cartItems"></div>
    </div>

    <!-- Bottom bar: ØµÙ†Ù | Ø®ØµÙ… | Ø¥Ø¬Ù…Ø§Ù„ÙŠ -->
    <div class="cart-bottom-bar">
      <span class="cbb-count" id="itemsCount">0 ØµÙ†Ù</span>
      <div class="cbb-disc">
        <label id="lblDiscount">Ø®ØµÙ…:</label>
        <input type="number" id="discountInput" placeholder="0.00" min="0" oninput="updateTotal()"/>
        <div class="discount-pills">
          <button class="disc-pill" onclick="applyPct(1)">1%</button>
          <button class="disc-pill" onclick="applyPct(2)">2%</button>
          <button class="disc-pill" onclick="applyPct(3)">3%</button>
          <button class="disc-pill" onclick="applyPct(5)">5%</button>
          <button class="disc-pill" onclick="applyPct(10)">10%</button>
        </div>
      </div>
      <div class="cbb-total">
        <span class="cbb-total-label" id="lblTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
        <span class="cbb-total-amount" id="totalAmount">0.00 DA</span>
        <span class="cbb-disc-badge" id="discountBadge"></span>
      </div>
    </div>

    <!-- Debt/Customer -->
    <div class="debt-row">
      <label id="lblPaid">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</label>
      <input type="number" id="paidInput" placeholder="0.00" min="0"/>
      <label id="lblCustomer">Ø§Ù„Ø²Ø¨ÙˆÙ†:</label>
      <div class="customer-select-wrap">
        <select id="customerSelect">
          <option value="" id="optSelectCustomer">â€” Ø§Ø®ØªØ± Ø§Ù„Ø²Ø¨ÙˆÙ† â€”</option>
        </select>
      </div>
    </div>

    <!-- Action Buttons â€” text only, no icons -->
    <div class="action-btns">
      <button class="btn btn-success btn-lg" onclick="openCheckout()">ØªØ³Ø¯ÙŠØ¯</button>
      <button class="btn btn-primary btn-lg" onclick="partialPayment()">Ø¬Ø²Ø¦ÙŠ + Ø¯ÙŠÙ†</button>
      <button class="btn btn-warning btn-lg" onclick="registerDebt()">Ø¯ÙŠÙ† ÙƒØ§Ù…Ù„</button>
    </div>
  </div>
</div>

<!-- Checkout Modal -->
<div class="modal-overlay" id="checkoutModal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <span class="modal-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹</span>
      <button class="modal-close" onclick="closeModal('checkoutModal')">âœ•</button>
    </div>
    <div id="checkoutSummary" style="margin-bottom:20px;"></div>
    <div class="modal-footer" style="gap:10px;">
      <button class="btn btn-primary" style="flex:2;" onclick="confirmSale(true)">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
      <button class="btn btn-secondary" style="flex:1;" onclick="confirmSale(false)">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- VKB -->
<button class="vkb-toggle" onclick="toggleVKB()">Ù„ÙˆØ­Ø©</button>
<div class="vkb-panel" id="vkbPanel">
  <div class="vkb-panel-header" id="vkbPanelHeader">
    <span id="vkbTitle">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­</span>
    <div style="display:flex;gap:4px;align-items:center;">
      <button class="vkb-lang-btn" onclick="setVKBLang('ar')" id="vkbLangAr"
        style="font-size:0.65rem;padding:2px 6px;border-radius:4px;border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.3);color:#fff;cursor:pointer;font-family:'Cairo',sans-serif;">Ø¹</button>
      <button class="vkb-lang-btn" onclick="setVKBLang('fr')" id="vkbLangFr"
        style="font-size:0.65rem;padding:2px 6px;border-radius:4px;border:1px solid rgba(255,255,255,0.3);background:transparent;color:#fff;cursor:pointer;font-family:'Cairo',sans-serif;">FR</button>
      <button class="vkb-lang-btn" onclick="setVKBLang('en')" id="vkbLangEn"
        style="font-size:0.65rem;padding:2px 6px;border-radius:4px;border:1px solid rgba(255,255,255,0.3);background:transparent;color:#fff;cursor:pointer;font-family:'Cairo',sans-serif;">EN</button>
      <button class="vkb-panel-close" onclick="toggleVKB()">âœ•</button>
    </div>
  </div>
  <div style="padding:8px;" id="vkbKeys"></div>
</div>

<!-- Sidebar â€” labels only, no icons -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-brand">POS DZ</div>
    <div class="sidebar-user" id="sidebarUser"></div>
  </div>
  <nav class="sidebar-nav">
    <a class="nav-item" href="sale.html">
      <span class="nav-label" data-nav="navSale">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹</span>
    </a>
    <a class="nav-item" href="inventory.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navInventory">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
    </a>
    <a class="nav-item" href="customers.html" data-role="admin,manager,seller">
      <span class="nav-label" data-nav="navCustomers">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</span>
    </a>
    <a class="nav-item" href="reports.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navReports">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</span>
    </a>
    <a class="nav-item" href="users.html" data-role="admin">
      <span class="nav-label" data-nav="navUsers">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
    </a>
    <a class="nav-item" href="suppliers.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navSuppliers">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ²Ø¹ÙŠÙ†</span>
    </a>
    <a class="nav-item" href="settings.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navSettings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</span>
    </a>
    <div class="nav-item danger" onclick="doLogout()">
      <span class="nav-label" data-nav="navLogout">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
    </div>
  </nav>
  <div class="sidebar-footer">POS DZ v6.0.0 | 2026 Ø¨ÙˆØ³ Ø¯ÙŠØ²Ø§Ø¯ Â®</div>
</div>

<div id="toast-container"></div>
<script src="app.js"></script>
<script>
'use strict';
let cart = JSON.parse(sessionStorage.getItem('posdz_cart') || '[]');
let allProducts = [];
let currency = 'DA';
let activeInput = null;

function saveCartSession() { sessionStorage.setItem('posdz_cart', JSON.stringify(cart)); }

async function init() {
  requireAuth();
  await initApp();
  currency = await getSetting('currency') || 'DA';
  allProducts = await dbGetAll('products');
  await loadCustomerSelect();
  renderCart();
  updateTotal();
  initSearch();
  initBarcodeScanner(async (code) => {
    const p = allProducts.find(x => x.barcode === code);
    if (p) { addToCart(p); playSound('add'); }
    else toast('Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ' + code, 'warning');
  });
  // Track active input for VKB â€” Ø§Ù„Ø®Ù„ÙÙŠØ© ØªØ¨Ù‚Ù‰ ØªÙØ§Ø¹Ù„ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹
  document.addEventListener('focusin', e => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      activeInput = e.target;
    }
  });
  // Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø®Ø§Ù†Ø© ÙŠÙØ­Ø¯Ù‘Ø« Ø§Ù„Ù‡Ø¯Ù Ù…Ø¨Ø§Ø´Ø±Ø© Ø­ØªÙ‰ Ù…Ø¹ ÙØªØ­ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
  document.addEventListener('mousedown', e => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      activeInput = e.target;
      // Ù„Ø§ Ù†Ù…Ù†Ø¹ Ø§Ù„Ù€ default â€” Ø§Ù„Ù€ input ÙŠØ³ØªÙ„Ù… Ø§Ù„Ù€ focus Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ
    }
  }, true); // capture=true â†’ ÙŠØ¹Ù…Ù„ Ù‚Ø¨Ù„ Ø£ÙŠ preventDefault Ø¢Ø®Ø±
  // Default VKB target = search
  activeInput = document.getElementById('searchInput');
  initDraggableVKB();
  const lang = await getSetting('language') || localStorage.getItem('posdz_lang') || 'ar';
  setVKBLang(lang === 'fr' ? 'fr' : lang === 'en' ? 'en' : 'ar');
  window.addEventListener('storage', (e) => {
    if (e.key === 'posdz_lang') {
      const nl = e.newValue || 'ar';
      setVKBLang(nl === 'fr' ? 'fr' : nl === 'en' ? 'en' : 'ar');
    }
  });
}

async function loadCustomerSelect() {
  const customers = await dbGetAll('customers');
  const sel = document.getElementById('customerSelect');
  const custLabel = (window._saleI18n && window._saleI18n.saleSelectCustomer) || 'â€” Ø§Ø®ØªØ± Ø§Ù„Ø²Ø¨ÙˆÙ† â€”';
  sel.innerHTML = `<option value="" id="optSelectCustomer">${custLabel}</option>`;
  customers.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    sel.appendChild(opt);
  });
}

// â”€â”€ Render Cart â”€â”€
function renderCart() {
  const container = document.getElementById('cartItems');
  if (!cart.length) {
    const emptyText = (window._saleI18n && window._saleI18n.saleNoProducts) || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª';
    container.innerHTML = `
      <div style="padding:40px;text-align:center;color:var(--text-secondary);
        font-size:1rem;font-weight:600;letter-spacing:0.5px;">
        ${emptyText}
      </div>`;
    return;
  }
  container.innerHTML = cart.map((item, idx) => `
    <div class="cart-item-row">
      <div class="cart-name-cell">
        <span class="cart-name-text">${item.name}</span>
        <span class="cart-type-badge">ØµÙ†Ù</span>
      </div>
      <div class="cart-qty-ctrl">
        <button class="cqc-btn minus" onclick="changeQty(${idx},-1)">âˆ’</button>
        <input class="cqc-val" type="number" value="${item.quantity}" min="1"
          onchange="updateQty(${idx}, this.value)" style="width:44px;"/>
        <button class="cqc-btn" onclick="changeQty(${idx},1)">+</button>
      </div>
      <span class="total-cell">${item.total.toFixed(2)}</span>
      <button class="del-btn" onclick="removeFromCart(${idx})" title="Ø­Ø°Ù">âœ•</button>
    </div>`).join('');
}

function addToCart(product) {
  const idx = cart.findIndex(i => i.productId === product.id);
  if (idx >= 0) {
    cart[idx].quantity++;
    cart[idx].total = cart[idx].quantity * cart[idx].unitPrice;
  } else {
    cart.push({ productId:product.id, name:product.name, quantity:1, unitPrice:product.sellPrice, total:product.sellPrice });
  }
  saveCartSession(); renderCart(); updateTotal(); playSound('add');
}

function changeQty(idx, delta) {
  const newQ = cart[idx].quantity + delta;
  if (newQ <= 0) { removeFromCart(idx); return; }
  cart[idx].quantity = newQ;
  cart[idx].total = newQ * cart[idx].unitPrice;
  saveCartSession(); renderCart(); updateTotal();
}

function updateQty(idx, val) {
  const q = Math.max(1, parseInt(val) || 1);
  cart[idx].quantity = q;
  cart[idx].total = q * cart[idx].unitPrice;
  saveCartSession(); renderCart(); updateTotal();
}

function updatePrice(idx, val) {
  const p = Math.max(0, parseFloat(val) || 0);
  cart[idx].unitPrice = p;
  cart[idx].total = cart[idx].quantity * p;
  saveCartSession(); updateTotal();
}

function removeFromCart(idx) {
  cart.splice(idx, 1);
  saveCartSession(); renderCart(); updateTotal();
}

function getTotal() {
  const subtotal = cart.reduce((s, i) => s + i.total, 0);
  const disc = parseFloat(document.getElementById('discountInput').value) || 0;
  return { total: Math.max(0, subtotal - disc), subtotal, discount: disc };
}

function updateTotal() {
  const { total, discount } = getTotal();
  document.getElementById('totalAmount').textContent = total.toFixed(2) + ' ' + currency;
  const qty = cart.reduce((s,i) => s + i.quantity, 0);
  document.getElementById('itemsCount').textContent = qty + ' ØµÙ†Ù (' + cart.length + ')';
  document.getElementById('discountBadge').textContent = discount > 0 ? 'Ø®ØµÙ…: -' + discount.toFixed(2) : '';
}

function applyPct(pct) {
  const { subtotal } = getTotal();
  document.getElementById('discountInput').value = (subtotal * pct / 100).toFixed(2);
  document.querySelectorAll('.disc-pill').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  updateTotal();
}

// â”€â”€ Checkout â”€â”€
function openCheckout() {
  if (!cart.length) { toast('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!', 'warning'); return; }
  const { total } = getTotal();
  document.getElementById('checkoutSummary').innerHTML = `
    <div style="text-align:center;">
      <div style="font-size:2rem;font-weight:900;color:var(--primary-light);font-family:Impact,sans-serif;
        text-shadow:0 0 14px var(--glow);margin-bottom:8px;">
        ${total.toFixed(2)} ${currency}
      </div>
      <div style="color:var(--text-secondary);font-size:0.9rem;font-weight:600;">${cart.length} ØµÙ†Ù</div>
    </div>`;
  openModal('checkoutModal');
}

async function confirmSale(doPrint = true) {
  const { total, discount } = getTotal();
  const invoiceNumber = await getNextInvoiceNumber();
  const user = getSession();
  const customerId = parseInt(document.getElementById('customerSelect').value) || null;
  const customer = customerId ? (await dbGetAll('customers')).find(c => c.id === customerId) : null;
  const saleId = await dbAdd('sales', {
    invoiceNumber, userId:user.id, customerId:customerId||0,
    total, discount, paid:total,
    isDebt:0, isCancelled:0, date:new Date().toISOString()
  });
  for (const item of cart) {
    await dbAdd('saleItems', { saleId, productId:item.productId, productName:item.name, quantity:item.quantity, unitPrice:item.unitPrice, total:item.total });
    const prod = await dbGet('products', item.productId);
    if (prod) { prod.quantity = Math.max(0, prod.quantity - item.quantity); await dbPut('products', prod); }
  }
  await dbAdd('logs', { action:'sale', details:`Ø¨ÙŠØ¹ ${invoiceNumber} â€” ${total.toFixed(2)} ${currency}`, date:new Date().toISOString() });
  if (doPrint) {
    const sale = { invoiceNumber, total, discount, paid:total, isDebt:0, date:new Date().toISOString(), customerName:customer?customer.name:'' };
    const items = cart.map(i => ({ productName:i.name, quantity:i.quantity, unitPrice:i.unitPrice, total:i.total }));
    await printInvoice(sale, items);
  }
  closeModal('checkoutModal');
  playSound('sell');
  toast('ØªÙ… Ø§Ù„Ø¨ÙŠØ¹ â€” ÙØ§ØªÙˆØ±Ø© ' + invoiceNumber, 'success');
  clearCart();
}

// â”€â”€ Partial Payment â”€â”€
async function partialPayment() {
  if (!cart.length) { toast('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!', 'warning'); return; }
  const customerId = parseInt(document.getElementById('customerSelect').value);
  if (!customerId) { toast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø²Ø¨ÙˆÙ† Ù„Ù„ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø²Ø¦ÙŠ', 'warning'); return; }
  const paidInput = parseFloat(document.getElementById('paidInput').value) || 0;
  if (paidInput <= 0) { toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹', 'warning'); return; }
  const { total, discount } = getTotal();
  if (paidInput >= total) { toast('Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØºØ·ÙŠ Ø§Ù„ÙƒÙ„ â€” Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„ØªØ³Ø¯ÙŠØ¯', 'warning'); return; }
  const debtAmount = total - paidInput;
  const invoiceNumber = await getNextInvoiceNumber();
  const user = getSession();
  const customers = await dbGetAll('customers');
  const customer = customers.find(c => c.id === customerId);
  const now = new Date().toISOString();
  const saleId = await dbAdd('sales', {
    invoiceNumber, userId:user.id, customerId,
    total, discount, paid:paidInput,
    isDebt:1, isCancelled:0, date:now,
    note:`Ø¨ÙŠØ¹ Ø¬Ø²Ø¦ÙŠ â€” Ù…Ø¯ÙÙˆØ¹: ${paidInput.toFixed(2)} â€” Ø¯ÙŠÙ†: ${debtAmount.toFixed(2)}`
  });
  for (const item of cart) {
    await dbAdd('saleItems', { saleId, productId:item.productId, productName:item.name, quantity:item.quantity, unitPrice:item.unitPrice, total:item.total });
    const prod = await dbGet('products', item.productId);
    if (prod) { prod.quantity = Math.max(0, prod.quantity - item.quantity); await dbPut('products', prod); }
  }
  const paidInvoice = await getNextInvoiceNumber();
  await dbAdd('sales', {
    invoiceNumber:paidInvoice, userId:user.id, customerId,
    total:paidInput, discount:0, paid:paidInput,
    isDebt:0, isCancelled:0, date:now,
    note:`Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† ÙØ§ØªÙˆØ±Ø© ${invoiceNumber}`
  });
  await dbAdd('debts', {
    customerId, saleId, amount:debtAmount,
    originalAmount:total, paidAtSale:paidInput,
    isPaid:0, date:now
  });
  await dbAdd('logs', {
    action:'partial_sale',
    details:`Ø¨ÙŠØ¹ Ø¬Ø²Ø¦ÙŠ ${invoiceNumber} â€” Ù…Ø¯ÙÙˆØ¹: ${paidInput.toFixed(2)} â€” Ø¯ÙŠÙ†: ${debtAmount.toFixed(2)} â€” ${customer?customer.name:''}`,
    date:now
  });
  playSound('sell');
  toast(`ØªÙ…: Ù…Ø¯ÙÙˆØ¹ ${paidInput.toFixed(2)} ${currency} â€” Ø¯ÙŠÙ† ${debtAmount.toFixed(2)} ${currency} Ø¹Ù„Ù‰ ${customer?customer.name:'â€”'}`, 'success', 4000);
  if (await customConfirmAsync('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¯ÙŠÙ†ØŸ')) {
    const saleObj = { invoiceNumber, total, discount, paid:paidInput, isDebt:1, date:now,
                      customerName:customer?customer.name:'', customerPhone:customer?customer.phone:'' };
    const items = cart.map(i => ({ productName:i.name, quantity:i.quantity, unitPrice:i.unitPrice, total:i.total }));
    await printInvoice(saleObj, items);
  }
  clearCart();
}

// â”€â”€ Full Debt â”€â”€
async function registerDebt() {
  if (!cart.length) { toast('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!', 'warning'); return; }
  const customerId = parseInt(document.getElementById('customerSelect').value);
  if (!customerId) { toast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø²Ø¨ÙˆÙ† Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†', 'warning'); return; }
  const { total, discount } = getTotal();
  const invoiceNumber = await getNextInvoiceNumber();
  const user = getSession();
  const customer = (await dbGetAll('customers')).find(c => c.id === customerId);
  const saleId = await dbAdd('sales', {
    invoiceNumber, userId:user.id, customerId, total, discount,
    paid:0, isDebt:1, isCancelled:0, date:new Date().toISOString()
  });
  for (const item of cart) {
    await dbAdd('saleItems', { saleId, productId:item.productId, productName:item.name, quantity:item.quantity, unitPrice:item.unitPrice, total:item.total });
    const prod = await dbGet('products', item.productId);
    if (prod) { prod.quantity = Math.max(0, prod.quantity - item.quantity); await dbPut('products', prod); }
  }
  await dbAdd('debts', { customerId, saleId, amount:total, originalAmount:total, isPaid:0, date:new Date().toISOString() });
  await dbAdd('logs', { action:'debt', details:`Ø¯ÙŠÙ† ${invoiceNumber} â€” ${total.toFixed(2)} ${currency} â€” ${customer?customer.name:''}`, date:new Date().toISOString() });
  toast(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙŠÙ† ${total.toFixed(2)} ${currency} Ø¹Ù„Ù‰ ${customer?customer.name:'â€”'}`, 'warning', 3500);
  if (await customConfirmAsync('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¯ÙŠÙ†ØŸ')) {
    const sale = { invoiceNumber, total, discount, paid:0, isDebt:1, date:new Date().toISOString(), customerName:customer?customer.name:'' };
    const items = cart.map(i => ({ productName:i.name, quantity:i.quantity, unitPrice:i.unitPrice, total:i.total }));
    await printInvoice(sale, items);
  }
  clearCart();
}

function clearCart() {
  cart = [];
  sessionStorage.removeItem('posdz_cart');
  document.getElementById('discountInput').value = '';
  document.getElementById('paidInput').value = '';
  document.getElementById('customerSelect').value = '';
  document.querySelectorAll('.disc-pill').forEach(b => b.classList.remove('active'));
  renderCart(); updateTotal();
}

// â”€â”€ Search â”€â”€
let _searchMatches = [];

function initSearch() {
  const input = document.getElementById('searchInput');
  const list  = document.getElementById('autocompleteList');

  input.addEventListener('input', () => {
    const q = input.value.trim();
    if (!q) { _searchMatches=[]; list.innerHTML=''; list.style.display='none'; return; }
    const ql = q.toLowerCase();
    _searchMatches = allProducts.filter(p => {
      if (!p||!p.name) return false;
      return p.name.toLowerCase().includes(ql) ||
             (p.barcode && p.barcode.includes(q)) ||
             (p.ref && p.ref.toLowerCase().includes(ql));
    }).slice(0, 10);
    if (!_searchMatches.length) { list.innerHTML=''; list.style.display='none'; return; }
    list.style.display = 'block';
    list.innerHTML = _searchMatches.map(p =>
      `<div class="autocomplete-item" onclick="selectProduct(${p.id})">
        <span style="font-weight:700;">${p.name}</span>
        <span class="item-price">${p.sellPrice.toFixed(2)} ${currency}</span>
      </div>`).join('');
  });

  // Enter ÙÙŠ Ø§Ù„Ø¨Ø­Ø« â†’ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (_searchMatches.length > 0) {
        selectProduct(_searchMatches[0].id);
        playSound('add');
      } else if (input.value.trim()) {
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ·Ø§Ø¨Ù‚ â€” Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        const p = allProducts.find(x => x.barcode === input.value.trim());
        if (p) { selectProduct(p.id); playSound('add'); }
        else toast('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'warning');
      }
    }
  });

  input.addEventListener('focus', () => { if (input.value.trim()) input.dispatchEvent(new Event('input')); });
  document.addEventListener('click', e => {
    if (!e.target.closest('.search-wrap')) { list.innerHTML=''; list.style.display='none'; }
  });
}

function selectProduct(id) {
  const p = allProducts.find(x => x.id === id);
  if (p) {
    addToCart(p);
    document.getElementById('searchInput').value = '';
    document.getElementById('autocompleteList').style.display = 'none';
  }
}

// â”€â”€ VKB â€” works in ALL pages/inputs â”€â”€
const VKB_LAYOUTS = {
  ar: {
    title:'Ù„ÙˆØ­Ø© Ø¹Ø±Ø¨ÙŠØ©',
    rows:[
      ['1','2','3','4','5','6','7','8','9','0','âŒ«'],
      ['Ø¶','Øµ','Ø«','Ù‚','Ù','Øº','Ø¹','Ù‡','Ø®','Ø­','Ø¬'],
      ['Ø´','Ø³','ÙŠ','Ø¨','Ù„','Ø§','Øª','Ù†','Ù…','Ùƒ','Ø·'],
      ['Ø¦','Ø¡','Ø¤','Ø±','Ù„Ø§','Ù‰','Ø©','Ùˆ','Ø²','Ø¸'],
      ['SPACE','ENTER']
    ]
  },
  fr: {
    title:'Clavier FranÃ§ais',
    rows:[
      ['1','2','3','4','5','6','7','8','9','0','âŒ«'],
      ['a','z','e','r','t','y','u','i','o','p'],
      ['q','s','d','f','g','h','j','k','l','m'],
      ['w','x','c','v','b','n',',','.','!','?'],
      ['Ã©','Ã¨','Ãª','Ã ','Ã¹','Ã¢','Ã´','Ã®','Ã»','Ã§'],
      ['SPACE','ENTER']
    ]
  },
  en: {
    title:'English Keyboard',
    rows:[
      ['1','2','3','4','5','6','7','8','9','0','âŒ«'],
      ['q','w','e','r','t','y','u','i','o','p'],
      ['a','s','d','f','g','h','j','k','l'],
      ['z','x','c','v','b','n','m',',','.'],
      ['SPACE','ENTER']
    ]
  }
};
let currentVKBLang = 'ar';

function setVKBLang(lang) {
  currentVKBLang = lang;
  const layout = VKB_LAYOUTS[lang] || VKB_LAYOUTS.ar;
  const container = document.getElementById('vkbKeys');
  const title = document.getElementById('vkbTitle');
  if (title) title.textContent = layout.title;
  ['ar','fr','en'].forEach(l => {
    const btn = document.getElementById('vkbLang' + l.charAt(0).toUpperCase() + l.slice(1));
    if (btn) btn.style.background = l === lang ? 'rgba(255,255,255,0.3)' : 'transparent';
  });
  if (!container) return;
  container.innerHTML = '';
  layout.rows.forEach(row => {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'vkb-row';
    row.forEach(key => {
      const btn = document.createElement('button');
      if (key === 'SPACE') {
        btn.className = 'vkb-key space';
        btn.textContent = lang==='ar' ? 'Ù…Ø³Ø§ÙØ©' : (lang==='fr' ? 'Espace' : 'Space');
        btn.onclick = () => vkbPress(' ');
      } else if (key === 'ENTER') {
        btn.className = 'vkb-key enter-key';
        btn.textContent = lang==='ar' ? 'Ø¥Ø¯Ø®Ø§Ù„ â†µ' : 'Enter â†µ';
        btn.style.cssText = 'background:var(--primary);color:#fff;font-weight:800;min-width:80px;';
        btn.onclick = () => vkbPress('ENTER');
      } else {
        btn.className = 'vkb-key' + (key==='âŒ«' ? ' delete' : '');
        btn.textContent = key;
        btn.onclick = () => vkbPress(key);
      }
      // Ù…Ù†Ø¹ Ø³Ø±Ù‚Ø© Ø§Ù„Ù€ focus Ù…Ù† Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ù…ÙØªØ§Ø­
      btn.addEventListener('mousedown', e => e.preventDefault());
      rowDiv.appendChild(btn);
    });
    container.appendChild(rowDiv);
  });
}

function toggleVKB() {
  document.getElementById('vkbPanel').classList.toggle('open');
}

function vkbPress(key) {
  const target = activeInput || document.getElementById('searchInput');
  if (!target) return;

  if (key === 'âŒ«') {
    const s = target.selectionStart;
    if (s > 0) {
      target.value = target.value.slice(0, s-1) + target.value.slice(s);
      target.setSelectionRange(s-1, s-1);
    }
  } else if (key === 'ENTER') {
    // Enter â€” ÙŠØ­Ø§ÙƒÙŠ Ø¶ØºØ·Ø© Enter Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    target.dispatchEvent(new KeyboardEvent('keydown', { key:'Enter', bubbles:true, cancelable:true }));
    target.dispatchEvent(new KeyboardEvent('keyup',   { key:'Enter', bubbles:true }));
    return;
  } else {
    const s = target.selectionStart;
    target.value = target.value.slice(0,s) + key + target.value.slice(s);
    target.setSelectionRange(s+key.length, s+key.length);
  }
  target.dispatchEvent(new Event('input', { bubbles:true }));
  // focus Ø¨Ø¯ÙˆÙ† scroll â€” ÙŠÙØ¨Ù‚ÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© ØªÙØ§Ø¹Ù„ÙŠØ©
  target.focus({ preventScroll: true });
}

function initDraggableVKB() {
  const panel  = document.getElementById('vkbPanel');
  const header = document.getElementById('vkbPanelHeader');
  let dragging=false, startX, startY, origLeft, origBottom;
  header.addEventListener('mousedown', e => {
    if (e.target.tagName==='BUTTON') return;
    dragging=true; startX=e.clientX; startY=e.clientY;
    const rect=panel.getBoundingClientRect();
    origLeft=rect.left; origBottom=window.innerHeight-rect.bottom;
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', ()=>{dragging=false;document.removeEventListener('mousemove',onMove);});
  });
  function onMove(e) {
    if (!dragging) return;
    panel.style.left   = Math.max(0, origLeft + e.clientX - startX) + 'px';
    panel.style.bottom = Math.max(0, origBottom - (e.clientY - startY)) + 'px';
    panel.style.right  = 'auto';
    panel.style.top    = 'auto';
  }
}

function doLogout() {
  customConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ', () => {
    clearSession(); window.location.href = 'index.html';
  });
}

init();
</script>
</body>
</html>
