<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POS DZ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .customer-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 16px 18px; margin-bottom: 10px;
      transition: var(--transition);
    }
    .customer-card:hover { border-color: var(--primary); box-shadow: 0 0 16px var(--glow); }
    .customer-card.has-debt { border-right: 4px solid var(--danger); }
    .customer-card.no-debt  { border-right: 4px solid var(--success); }
    .cust-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .cust-name { font-size:1.05rem; font-weight:800; color:var(--text-primary); }
    .cust-phone { font-size:0.82rem; color:var(--text-secondary); }
    .cust-debt-amount { font-size:1.2rem; font-weight:900; color:var(--danger); }
    .cust-debt-none { font-size:0.85rem; color:var(--success); font-weight:700; }
    .cust-actions { display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
    .cust-actions .btn { font-size:0.8rem; padding:6px 12px; }
    .debt-detail-row {
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 0; border-bottom:1px solid var(--border); font-size:0.88rem;
    }
    .debt-detail-row:last-child { border-bottom:none; }
    .debt-detail-date { font-size:0.75rem; color:var(--text-secondary); }
    .partial-modal-info { background:var(--bg-dark); border-radius:var(--radius-sm); padding:12px 16px; margin-bottom:14px; }
    .stats-row { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:18px; }
  </style>
</head>
<body>
<div class="bg-animated"></div>
<div class="page-wrapper">
  <header class="app-header">
    <button class="menu-btn" id="menuBtn" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">â˜°</button>
    <span class="store-name" id="headerStoreName">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</span>
    <!-- Bell injected by app.js via _injectBell() -->
    <div class="app-brand">
      <span class="brand-title">POS DZ</span>
      <span class="brand-clock" id="clockDisplay"></span>
    </div>
  </header>
  <div class="main-content">
    <div class="section-header">
      <a href="sale.html" class="back-btn">â† Ø±Ø¬ÙˆØ¹</a>
      <h2 class="page-title">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</h2>
      <button class="btn btn-primary" onclick="openModal('addCustomerModal')"><span data-i18n="custAdd">â• Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ†</span></button>
    </div>

    <!-- Stats -->
    <div class="stats-row" id="customerStats"></div>

    <!-- Search -->
    <div class="search-bar" style="margin-bottom:14px;">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="customerSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." data-i18n-ph="custSearch" oninput="filterCustomers()"/>
    </div>

    <!-- Filter tabs -->
    <div class="tabs-bar" style="margin-bottom:14px;">
      <button class="tab-btn active" onclick="setFilter('all')" data-i18n="custFilterAll">Ø§Ù„ÙƒÙ„</button>
      <button class="tab-btn" onclick="setFilter('debt')" data-i18n="custFilterDebt">ğŸ’³ Ù…Ø¯ÙŠÙˆÙ†ÙˆÙ†</button>
      <button class="tab-btn" onclick="setFilter('clear')" data-i18n="custFilterClear">âœ… Ù…Ø³Ø¯Ø¯ÙˆÙ†</button>
    </div>

    <!-- Customer Cards -->
    <div id="customersContainer"></div>
  </div>
</div>

<!-- Add/Edit Customer Modal -->
<div class="modal-overlay" id="addCustomerModal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <span class="modal-title" id="customerModalTitle">â• Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</span>
      <button class="modal-close" onclick="closeModal('addCustomerModal')">âœ•</button>
    </div>
    <input type="hidden" id="editCustomerId"/>
    <div class="input-group">
      <label class="input-label" data-i18n="custName">ğŸ‘¤ Ø§Ù„Ø§Ø³Ù… *</label>
      <input class="input-field" type="text" id="customerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†"/>
    </div>
    <div class="input-group">
      <label class="input-label" data-i18n="custPhone">ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ *</label>
      <input class="input-field" type="tel" id="customerPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"/>
    </div>
    <div class="modal-footer">
      <button class="btn btn-success" onclick="saveCustomer()">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="btn btn-secondary" onclick="closeModal('addCustomerModal')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Debt Details Modal -->
<div class="modal-overlay" id="debtDetailModal">
  <div class="modal" style="max-width:580px;">
    <div class="modal-header">
      <span class="modal-title" id="debtDetailTitle">ğŸ’³ Ø¯ÙŠÙˆÙ† Ø§Ù„Ø²Ø¨ÙˆÙ†</span>
      <button class="modal-close" onclick="closeModal('debtDetailModal')">âœ•</button>
    </div>
    <div id="debtDetailContent"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('debtDetailModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Partial Payment Modal -->
<div class="modal-overlay" id="partialPayModal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <span class="modal-title">ğŸ’° ØªØ³Ø¯ÙŠØ¯ Ø¬Ø²Ø¦ÙŠ</span>
      <button class="modal-close" onclick="closeModal('partialPayModal')">âœ•</button>
    </div>
    <div class="partial-modal-info" id="partialPayInfo"></div>
    <div class="input-group">
      <label class="input-label">ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
      <input class="input-field" type="number" id="partialPayAmount" placeholder="0.00" style="font-size:1.2rem;text-align:center;" oninput="updatePartialRemain()"/>
    </div>
    <div id="partialRemainDisplay" style="text-align:center;font-weight:700;margin:8px 0;"></div>
    <div class="modal-footer">
      <button class="btn btn-success" onclick="confirmPartialPay()">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹</button>
      <button class="btn btn-secondary" onclick="closeModal('partialPayModal')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Sidebar â€” labels only, no icons -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-brand">POS DZ</div>
    <div class="sidebar-user" id="sidebarUser"></div>
  </div>
  <nav class="sidebar-nav">
    <a class="nav-item" href="sale.html">
      <span class="nav-label" data-nav="navSale">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹</span>
    </a>
    <a class="nav-item" href="inventory.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navInventory">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
    </a>
    <a class="nav-item" href="customers.html" data-role="admin,manager,seller">
      <span class="nav-label" data-nav="navCustomers">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</span>
    </a>
    <a class="nav-item" href="reports.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navReports">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</span>
    </a>
    <a class="nav-item" href="users.html" data-role="admin">
      <span class="nav-label" data-nav="navUsers">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
    </a>
    <a class="nav-item" href="suppliers.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navSuppliers">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ²Ø¹ÙŠÙ†</span>
    </a>
    <a class="nav-item" href="settings.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navSettings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</span>
    </a>
    <div class="nav-item danger" onclick="doLogout()">
      <span class="nav-label" data-nav="navLogout">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
    </div>
  </nav>
  <div class="sidebar-footer">POS DZ v6.0.0 | 2026 Ø¨ÙˆØ³ Ø¯ÙŠØ²Ø§Ø¯ Â®</div>
</div>
<div id="toast-container"></div>
<script src="app.js"></script>
<script>
'use strict';
let allCustomers = [];
let allDebts = [];
let currency = 'DA';
let currentFilter = 'all';
let activeDebtId = null;
let activeDebtCustomerId = null;
let activeDebtTotal = 0;

async function init() {
  requireAuth();
  await initApp();
  currency = await getSetting('currency') || 'DA';
  await loadAll();
  // Enter ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø²Ø¨ÙˆÙ† â€” Ø§Ù„Ø§Ø³Ù… â†’ Ø§Ù„Ù‡Ø§ØªÙ â†’ Ø­ÙØ¸
  document.getElementById('customerName')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); document.getElementById('customerPhone')?.focus(); }
  });
  document.getElementById('customerPhone')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); saveCustomer(); }
  });
}

async function loadAll() {
  allCustomers = await dbGetAll('customers');
  allDebts     = await dbGetAll('debts');
  renderStats();
  renderCustomers();
}

function renderStats() {
  const debtors   = new Set(allDebts.filter(d => !d.isPaid).map(d => d.customerId)).size;
  const totalDebt = allDebts.filter(d => !d.isPaid).reduce((s, d) => s + d.amount, 0);
  const cleared   = allCustomers.filter(c => !allDebts.find(d => d.customerId === c.id && !d.isPaid)).length;
  document.getElementById('customerStats').innerHTML = `
    <div class="stat-card"><div class="stat-icon">ğŸ‘¥</div><div class="stat-value">${allCustomers.length}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</div></div>
    <div class="stat-card"><div class="stat-icon">ğŸ’³</div><div class="stat-value" style="color:var(--danger)">${totalDebt.toFixed(0)}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† (${currency})</div></div>
    <div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-value" style="color:var(--success)">${cleared}</div><div class="stat-label">Ø²Ø¨Ø§Ø¦Ù† Ø¨Ø¯ÙˆÙ† Ø¯ÙŠÙˆÙ†</div></div>`;
}

function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('.tabs-bar .tab-btn').forEach((b,i) => b.classList.toggle('active', ['all','debt','clear'][i] === f));
  renderCustomers();
}

function filterCustomers() { renderCustomers(); }

function renderCustomers() {
  const q = (document.getElementById('customerSearch').value || '').toLowerCase();
  let list = allCustomers.filter(c =>
    c.name.toLowerCase().includes(q) || (c.phone && c.phone.includes(q)));

  if (currentFilter === 'debt')  list = list.filter(c => allDebts.find(d => d.customerId === c.id && !d.isPaid));
  if (currentFilter === 'clear') list = list.filter(c => !allDebts.find(d => d.customerId === c.id && !d.isPaid));

  if (!list.length) {
    document.getElementById('customersContainer').innerHTML =
      '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨Ø§Ø¦Ù†</p></div>';
    return;
  }

  document.getElementById('customersContainer').innerHTML = list.map(c => {
    const debts    = allDebts.filter(d => d.customerId === c.id && !d.isPaid);
    const totalDebt = debts.reduce((s, d) => s + d.amount, 0);
    const hasDebt  = totalDebt > 0;
    const lastDebt = debts.sort((a,b) => new Date(b.date)-new Date(a.date))[0];

    return `<div class="customer-card ${hasDebt ? 'has-debt' : 'no-debt'}">
      <div class="cust-header">
        <div>
          <div class="cust-name">ğŸ‘¤ ${c.name}</div>
          <div class="cust-phone">ğŸ“ ${c.phone || 'â€”'}</div>
          ${lastDebt ? `<div style="font-size:0.75rem;color:var(--warning);margin-top:2px;">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙŠÙ†: ${formatDate(lastDebt.date)}</div>` : ''}
        </div>
        <div style="text-align:left;">
          ${hasDebt
            ? `<div class="cust-debt-amount">${totalDebt.toFixed(2)} ${currency}</div><div style="font-size:0.72rem;color:var(--danger);">Ø¯ÙŠÙ† Ù…ØªØ¨Ù‚ÙŠ</div>`
            : `<div class="cust-debt-none">âœ… Ù„Ø§ Ø¯ÙŠÙˆÙ†</div>`}
        </div>
      </div>
      <div class="cust-actions">
        <button class="btn btn-secondary btn-sm" onclick="viewDebts(${c.id})" title="Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ†">ğŸ“‹ Ø§Ù„Ø¯ÙŠÙˆÙ†</button>
        ${hasDebt ? `
        <button class="btn btn-warning btn-sm" onclick="openPartialModal(${c.id},${totalDebt})" title="ØªØ³Ø¯ÙŠØ¯ Ø¬Ø²Ø¡">ğŸ’° Ø¬Ø²Ø¦ÙŠ</button>
        <button class="btn btn-success btn-sm" onclick="payAllDebts(${c.id},${totalDebt})" title="ØªØ³Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„">âœ… ØªØ³Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
        <button class="btn btn-primary btn-sm" onclick="printDebtInvoice(${c.id})" title="Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¯ÙŠÙ†">ğŸ–¨ï¸ ÙØ§ØªÙˆØ±Ø© Ø¯ÙŠÙ†</button>
        ` : ''}
        <button class="btn btn-sm" style="background:transparent;border:1px solid var(--border);" onclick="editCustomer(${c.id})" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
        <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${c.id})" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

// View all debts for a customer
async function viewDebts(customerId) {
  const c = allCustomers.find(x => x.id === customerId);
  const debts = allDebts.filter(d => d.customerId === customerId);
  const unpaid = debts.filter(d => !d.isPaid);
  const paid   = debts.filter(d =>  d.isPaid);

  document.getElementById('debtDetailTitle').textContent = `ğŸ’³ Ø¯ÙŠÙˆÙ†: ${c ? c.name : ''}`;

  let html = '';
  if (unpaid.length) {
    html += `<h5 style="color:var(--danger);margin:0 0 10px;">ğŸ“‹ Ø¯ÙŠÙˆÙ† Ù‚Ø§Ø¦Ù…Ø© (${unpaid.length})</h5>`;
    const sales = await Promise.all(unpaid.map(d => dbGet('sales', d.saleId)));
    html += unpaid.map((d, i) => {
      const s = sales[i];
      return `<div class="debt-detail-row">
        <div>
          <div style="font-weight:700;">ÙØ§ØªÙˆØ±Ø©: ${s ? s.invoiceNumber : 'â€”'}</div>
          <div class="debt-detail-date">ğŸ“… ${formatDate(d.date)}</div>
          ${d.originalAmount && d.originalAmount !== d.amount
            ? `<div class="debt-detail-date" style="color:var(--warning);">Ø§Ù„Ø£ØµÙ„ÙŠ: ${d.originalAmount.toFixed(2)} | Ù…Ø³Ø¯Ø¯: ${(d.originalAmount - d.amount).toFixed(2)}</div>` : ''}
        </div>
        <div style="text-align:left;">
          <div style="color:var(--danger);font-weight:900;">${d.amount.toFixed(2)} ${currency}</div>
          <div style="display:flex;gap:4px;margin-top:4px;">
            <button class="btn btn-warning btn-sm" onclick="openPartialModal(${customerId},${d.amount},${d.id})" style="font-size:0.75rem;padding:3px 7px;">ğŸ’° Ø¬Ø²Ø¦ÙŠ</button>
            <button class="btn btn-success btn-sm" onclick="payDebt(${d.id},${d.amount},${customerId})" style="font-size:0.75rem;padding:3px 7px;">âœ… ÙƒÙ„ÙŠ</button>
            ${s ? `<button class="btn btn-secondary btn-sm" onclick="printOneDebt(${d.id})" style="font-size:0.75rem;padding:3px 7px;">ğŸ–¨ï¸</button>` : ''}
          </div>
        </div>
      </div>`;
    }).join('');
  }
  if (paid.length) {
    html += `<h5 style="color:var(--success);margin:14px 0 10px;">âœ… Ø¯ÙŠÙˆÙ† Ù…Ø³Ø¯Ø¯Ø© (${paid.length})</h5>`;
    html += paid.slice(-5).reverse().map(d =>
      `<div class="debt-detail-row" style="opacity:0.6;">
        <div>
          <div style="font-size:0.82rem;"><s>${(d.originalAmount||d.amount).toFixed(2)} ${currency}</s></div>
          <div class="debt-detail-date">ğŸ“… Ø³ÙØ¯ÙÙ‘Ø¯: ${formatDate(d.paidDate || d.date)}</div>
        </div>
        <div><span class="badge badge-success">âœ… Ù…Ø³Ø¯Ø¯</span></div>
      </div>`).join('');
  }
  if (!debts.length) html = '<p class="text-muted" style="text-align:center;padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ†</p>';
  document.getElementById('debtDetailContent').innerHTML = html;
  openModal('debtDetailModal');
}

// Partial payment modal
let _partialSingleDebtId = null;
function openPartialModal(customerId, totalAmount, singleDebtId = null) {
  activeDebtCustomerId = customerId;
  activeDebtTotal = totalAmount;
  _partialSingleDebtId = singleDebtId;
  const c = allCustomers.find(x => x.id === customerId);
  document.getElementById('partialPayInfo').innerHTML = `
    <div style="font-weight:700;color:var(--primary-light);font-size:1rem;margin-bottom:4px;">ğŸ‘¤ ${c ? c.name : ''}</div>
    <div>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <b style="color:var(--danger);font-size:1.1rem;">${totalAmount.toFixed(2)} ${currency}</b></div>`;
  document.getElementById('partialPayAmount').value = '';
  document.getElementById('partialRemainDisplay').textContent = '';
  closeModal('debtDetailModal');
  openModal('partialPayModal');
}

function updatePartialRemain() {
  const paid   = parseFloat(document.getElementById('partialPayAmount').value) || 0;
  const remain = activeDebtTotal - paid;
  const el     = document.getElementById('partialRemainDisplay');
  if (paid > 0) {
    if (paid >= activeDebtTotal) { el.textContent = 'âœ… ÙŠÙƒÙÙŠ Ù„Ù„ØªØ³Ø¯ÙŠØ¯ Ø§Ù„ÙƒØ§Ù…Ù„'; el.style.color = 'var(--success)'; }
    else { el.textContent = `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹: ${remain.toFixed(2)} ${currency}`; el.style.color = 'var(--warning)'; }
  } else el.textContent = '';
}

async function confirmPartialPay() {
  const paid = parseFloat(document.getElementById('partialPayAmount').value) || 0;
  if (!paid || paid <= 0) { toast('âš ï¸ Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹', 'warning'); return; }
  if (paid >= activeDebtTotal) {
    closeModal('partialPayModal');
    await payAllDebts(activeDebtCustomerId, activeDebtTotal);
    return;
  }

  const now  = new Date().toISOString();
  const user = getSession();
  const c    = allCustomers.find(x => x.id === activeDebtCustomerId);

  if (_partialSingleDebtId) {
    // Pay specific debt partially
    const debt = await dbGet('debts', _partialSingleDebtId);
    if (debt) {
      debt.originalAmount = debt.originalAmount || debt.amount;
      debt.amount = debt.amount - paid;
      await dbPut('debts', debt);
    }
  } else {
    // Pay against all unpaid debts (oldest first)
    let remaining = paid;
    const unpaid = allDebts.filter(d => d.customerId === activeDebtCustomerId && !d.isPaid)
                           .sort((a,b) => new Date(a.date) - new Date(b.date));
    for (const d of unpaid) {
      if (remaining <= 0) break;
      if (remaining >= d.amount) { remaining -= d.amount; d.isPaid = 1; d.paidDate = now; d.originalAmount = d.originalAmount || d.amount; await dbPut('debts', d); }
      else { d.originalAmount = d.originalAmount || d.amount; d.amount -= remaining; await dbPut('debts', d); remaining = 0; }
    }
  }

  // Register as a sale (settlement record)
  const invoiceNumber = await getNextInvoiceNumber();
  await dbAdd('sales', {
    invoiceNumber, userId: user.id, customerId: activeDebtCustomerId,
    total: paid, discount: 0, paid,
    isDebt: 0, isCancelled: 0, date: now,
    debtSettlement: true,
    note: `ØªØ³Ø¯ÙŠØ¯ Ø¬Ø²Ø¦ÙŠ Ø¯ÙŠÙ† â€” ${c ? c.name : ''}`
  });
  await dbAdd('logs', { action: 'partial_debt_pay', details: `ØªØ³Ø¯ÙŠØ¯ Ø¬Ø²Ø¦ÙŠ ${paid} ${currency} â€” ${c ? c.name : ''}`, date: now });

  toast(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ ${paid.toFixed(2)} ${currency}`, 'success', 3000);
  closeModal('partialPayModal');

  if (await customConfirmAsync('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© ÙˆØµÙ„ Ø§Ù„ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø²Ø¦ÙŠØŸ')) {
    // Recalculate remaining debt after payment
    const updatedDebts = await dbGetAll('debts');
    const remainAfter = updatedDebts.filter(d => d.customerId === activeDebtCustomerId && !d.isPaid).reduce((s,d)=>s+d.amount,0);
    await printInvoice({
      invoiceNumber, total: paid, discount: 0, paid,
      isDebt: 0, date: now,
      customerName: c ? c.name : '',
      customerPhone: c ? c.phone : '',
      debtSettlement: true,
      partialSettlement: true,
      remainingAfterPay: remainAfter
    }, [{ productName: `ØªØ³Ø¯ÙŠØ¯ Ø¬Ø²Ø¦ÙŠ â€” Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remainAfter.toFixed(2)}`, quantity: 1, unitPrice: paid, total: paid }]);
  }
  await loadAll();
}

async function payDebt(debtId, amount, customerId) {
  const _ok1 = await customConfirmAsync(`ØªØ³Ø¯ÙŠØ¯ ${amount.toFixed(2)} ${currency}ØŸ`);
  if (!_ok1) return;
  const now  = new Date().toISOString();
  const debt = await dbGet('debts', debtId);
  const c    = allCustomers.find(x => x.id === customerId);
  debt.isPaid = 1; debt.paidDate = now;
  debt.originalAmount = debt.originalAmount || debt.amount;
  await dbPut('debts', debt);
  if (debt.saleId) {
    const s = await dbGet('sales', debt.saleId);
    if (s) { s.isDebt = 0; s.debtPaidDate = now; await dbPut('sales', s); }
  }
  const invoiceNumber = await getNextInvoiceNumber();
  const user = getSession();
  await dbAdd('sales', {
    invoiceNumber, userId: user.id, customerId,
    total: amount, discount: 0, paid: amount,
    isDebt: 0, isCancelled: 0, date: now,
    debtSettlement: true, note: `ØªØ³Ø¯ÙŠØ¯ ÙƒÙ„ÙŠ Ù„Ø¯ÙŠÙ† â€” ${c ? c.name : ''}`
  });
  await dbAdd('logs', { action: 'debt_paid', details: `ØªØ³Ø¯ÙŠØ¯ ÙƒÙ„ÙŠ ${amount} ${currency} â€” ${c ? c.name : ''}`, date: now });
  toast(`âœ… ØªÙ… ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙŠÙ† ${amount.toFixed(2)} ${currency}`, 'success');
  closeModal('debtDetailModal');
  if (await customConfirmAsync('Ø·Ø¨Ø§Ø¹Ø© ÙˆØµÙ„ Ø§Ù„ØªØ³Ø¯ÙŠØ¯ØŸ')) {
    await printInvoice({
      invoiceNumber, total: amount, discount: 0, paid: amount,
      isDebt: 0, date: now, customerName: c ? c.name : '', debtSettlement: true
    }, [{ productName: 'ØªØ³Ø¯ÙŠØ¯ Ø¯ÙŠÙ†', quantity: 1, unitPrice: amount, total: amount }]);
  }
  await loadAll();
}

async function payAllDebts(customerId, totalAmount) {
  const _ok2 = await customConfirmAsync(`ØªØ³Ø¯ÙŠØ¯ ÙƒØ§Ù…Ù„ Ø§Ù„Ø¯ÙŠÙˆÙ†: ${totalAmount.toFixed(2)} ${currency}ØŸ`);
  if (!_ok2) return;
  const now  = new Date().toISOString();
  const c    = allCustomers.find(x => x.id === customerId);
  const unpaid = allDebts.filter(d => d.customerId === customerId && !d.isPaid);
  for (const d of unpaid) {
    d.isPaid = 1; d.paidDate = now;
    d.originalAmount = d.originalAmount || d.amount;
    await dbPut('debts', d);
    if (d.saleId) { const s = await dbGet('sales', d.saleId); if (s) { s.isDebt = 0; s.debtPaidDate = now; await dbPut('sales', s); } }
  }
  const invoiceNumber = await getNextInvoiceNumber();
  const user = getSession();
  await dbAdd('sales', {
    invoiceNumber, userId: user.id, customerId,
    total: totalAmount, discount: 0, paid: totalAmount,
    isDebt: 0, isCancelled: 0, date: now,
    debtSettlement: true, note: `ØªØ³Ø¯ÙŠØ¯ ÙƒÙ„ÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙŠÙˆÙ† â€” ${c ? c.name : ''}`
  });
  await dbAdd('logs', { action: 'all_debt_paid', details: `ØªØ³Ø¯ÙŠØ¯ ÙƒÙ„ÙŠ ${totalAmount} ${currency} â€” ${c ? c.name : ''}`, date: now });
  toast(`âœ… ØªÙ… ØªØ³Ø¯ÙŠØ¯ ÙƒØ§Ù…Ù„ Ø§Ù„Ø¯ÙŠÙˆÙ†: ${totalAmount.toFixed(2)} ${currency}`, 'success', 3000);
  if (await customConfirmAsync('Ø·Ø¨Ø§Ø¹Ø© ÙˆØµÙ„ Ø§Ù„ØªØ³Ø¯ÙŠØ¯ØŸ')) {
    await printInvoice({
      invoiceNumber, total: totalAmount, discount: 0, paid: totalAmount,
      isDebt: 0, date: now, customerName: c ? c.name : '', debtSettlement: true
    }, [{ productName: 'ØªØ³Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙŠÙˆÙ†', quantity: 1, unitPrice: totalAmount, total: totalAmount }]);
  }
  await loadAll();
}

async function printDebtInvoice(customerId) {
  const c    = allCustomers.find(x => x.id === customerId);
  const debts = allDebts.filter(d => d.customerId === customerId && !d.isPaid);
  if (!debts.length) { toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ†', 'info'); return; }
  const totalDebt = debts.reduce((s, d) => s + d.amount, 0);
  const firstSale = debts[0].saleId ? await dbGet('sales', debts[0].saleId) : null;
  const invoiceNumber = firstSale?.invoiceNumber || 'â€”';
  // Build items list showing each debt with its original date
  const items = await Promise.all(debts.map(async d => {
    const s = await dbGet('sales', d.saleId);
    return {
      productName: `Ø¯ÙŠÙ† â€” ${formatDate(d.date)} (${s ? s.invoiceNumber : 'â€”'})`,
      quantity: 1,
      unitPrice: d.amount,
      total: d.amount
    };
  }));
  await printInvoice({
    invoiceNumber,
    total: totalDebt,
    discount: 0,
    paid: 0,
    isDebt: 1,
    date: debts[0].date,
    customerName: c ? c.name : '',
    customerPhone: c ? c.phone : ''
  }, items);
}

async function printOneDebt(debtId) {
  const debt = allDebts.find(d => d.id === debtId);
  if (!debt) return;
  const c    = allCustomers.find(x => x.id === debt.customerId);
  const sale = await dbGet('sales', debt.saleId);
  const origAmount = debt.originalAmount || debt.amount;
  const paidSoFar  = origAmount - debt.amount;
  await printInvoice({
    invoiceNumber:  sale ? sale.invoiceNumber : 'â€”',
    total:          origAmount,
    discount:       sale ? (sale.discount || 0) : 0,
    paid:           paidSoFar,
    remainingDebt:  debt.amount,
    isDebt:         1,
    date:           debt.date,
    customerName:   c ? c.name : '',
    customerPhone:  c ? c.phone : ''
  }, sale
    ? (await dbGetAll('saleItems')).filter(i => i.saleId === debt.saleId)
    : [{ productName: 'Ø¯ÙŠÙ†', quantity: 1, unitPrice: origAmount, total: origAmount }]);
}

async function saveCustomer() {
  const id    = document.getElementById('editCustomerId').value;
  const name  = document.getElementById('customerName').value.trim();
  const phone = document.getElementById('customerPhone').value.trim();
  if (!name || !phone) { toast('Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†', 'warning'); return; }
  const data = { name, phone, createdAt: new Date().toISOString() };
  if (id) { data.id = parseInt(id); await dbPut('customers', data); toast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…', 'success'); }
  else { await dbAdd('customers', data); toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…', 'success'); }
  closeModal('addCustomerModal');
  document.getElementById('editCustomerId').value = '';
  document.getElementById('customerName').value   = '';
  document.getElementById('customerPhone').value  = '';
  await loadAll();
}

async function editCustomer(id) {
  const c = allCustomers.find(x => x.id === id);
  if (!c) return;
  document.getElementById('editCustomerId').value = c.id;
  document.getElementById('customerName').value   = c.name;
  document.getElementById('customerPhone').value  = c.phone || '';
  document.getElementById('customerModalTitle').textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†';
  openModal('addCustomerModal');
}

async function deleteCustomer(id) {
  const hasDebt = allDebts.find(d => d.customerId === id && !d.isPaid);
  if (hasDebt) { toast('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø²Ø¨ÙˆÙ† Ù„Ø¯ÙŠÙ‡ Ø¯ÙŠÙˆÙ† ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©', 'warning'); return; }
  if (!await customConfirmAsync('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ†ØŸ')) return;
  await dbDelete('customers', id);
  toast('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'success');
  await loadAll();
}

function doLogout() { customConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ', () => { clearSession(); window.location.href = 'index.html'; }); }
init();
</script>
</body>
</html>
