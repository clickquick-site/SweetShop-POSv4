<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POS DZ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .alert-box { background: var(--bg-card); border: 1px solid var(--warning); border-radius: var(--radius); padding: 14px 18px; margin-bottom: 16px; }
    .alert-box h4 { color: var(--warning); font-size: 0.9rem; margin-bottom: 8px; }
    .alert-item { font-size: 0.85rem; color: var(--text-secondary); padding: 3px 0; }
    .stock-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; }
    .stock-ok { background: rgba(16,185,129,0.2); color: var(--success); }
    .stock-low { background: rgba(245,158,11,0.2); color: var(--warning); }
    .stock-out { background: rgba(239,68,68,0.2); color: var(--danger); }
    .expiry-warn { background: rgba(239,68,68,0.2); color: var(--danger); }
  </style>
</head>
<body>
<div class="bg-animated"></div>
<div class="page-wrapper">
  <!-- HEADER -->
  <header class="app-header">
    <button class="menu-btn" id="menuBtn" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">â˜°</button>
    <span class="store-name" id="headerStoreName">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</span>
    <!-- Bell injected by app.js via _injectBell() -->
    <div class="app-brand">
      <span class="brand-title">POS DZ</span>
      <span class="brand-clock" id="clockDisplay"></span>
    </div>
  </header>

  <div class="main-content">
    <!-- Page Header -->
    <div class="section-header">
      <a href="sale.html" class="back-btn">â† Ø±Ø¬ÙˆØ¹</a>
      <h2 class="page-title">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
    </div>

    <!-- Alerts -->
    <div class="alert-box" id="alertsBox" style="display:none;">
      <h4>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h4>
      <div id="alertsList"></div>
    </div>

    <!-- Tabs -->
    <div class="tabs-bar">
      <button class="tab-btn active" onclick="switchTab('all')">ğŸ“‹ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
      <button class="tab-btn" onclick="switchTab('add')">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
      <button class="tab-btn" onclick="switchTab('families')">ğŸ·ï¸ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª</button>
      <button class="tab-btn" onclick="switchTab('import')">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ / ØªØµØ¯ÙŠØ±</button>
    </div>

    <!-- TAB: All Products -->
    <div class="tab-content active" id="tab-all">
      <div class="search-bar">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="productSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯..." oninput="filterProducts()"/>
      </div>
      <div class="card" style="padding:0;overflow:hidden;">
        <table class="data-table" id="productsTable">
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th>
              <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>ØªÙ†Ø¨ÙŠÙ‡</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="productsTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- TAB: Add Product -->
    <div class="tab-content" id="tab-add">
      <div class="card">
        <h3 id="formTitle" style="color:var(--primary-light);margin-bottom:18px;">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
        <input type="hidden" id="editProductId"/>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="input-group">
            <label class="input-label">ğŸ·ï¸ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label>
            <select class="select-field" id="productFamily">
              <option value="">-- Ø¨Ø¯ÙˆÙ† Ø¹Ø§Ø¦Ù„Ø© --</option>
            </select>
          </div>
          <div class="input-group">
            <label class="input-label">ğŸ“ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *</label>
            <input class="input-field" type="text" id="productName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"/>
          </div>
          <div class="input-group">
            <label class="input-label">ğŸ“ Ø§Ù„Ø­Ø¬Ù… / Ø§Ù„Ù…Ù‚Ø§Ø³ / Ø§Ù„Ø³Ø¹Ø©</label>
            <input class="input-field" type="text" id="productSize" placeholder="Ù…Ø«Ø§Ù„: 500mlØŒ LØŒ XL"/>
          </div>
          <div class="input-group">
            <label class="input-label">ğŸ“¦ Ø§Ù„ÙˆØ­Ø¯Ø©</label>
            <select class="select-field" id="productUnit">
              <option>Ù‚Ø·Ø¹Ø©</option><option>ÙƒÙŠÙ„Ùˆ</option><option>ØºØ±Ø§Ù…</option>
              <option>Ù„ØªØ±</option><option>Ø¹Ù„Ø¨Ø©</option><option>ÙƒØ±ØªÙˆÙ†</option>
            </select>
          </div>
          <div class="input-group">
            <label class="input-label">ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label>
            <input class="input-field" type="number" id="productBuyPrice" placeholder="0.00" min="0"/>
          </div>
          <div class="input-group">
            <label class="input-label">ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ *</label>
            <input class="input-field" type="number" id="productSellPrice" placeholder="0.00" min="0"/>
          </div>
          <div class="input-group">
            <label class="input-label">ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
            <input class="input-field" type="number" id="productQty" placeholder="0" min="0"/>
          </div>
          <div class="input-group">
            <label class="input-label">ğŸ“… ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
            <input class="input-field" type="date" id="productExpiry"/>
          </div>
          <div class="input-group" style="grid-column:1/-1;">
            <label class="input-label">ğŸ“· Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
            <input class="input-field" type="text" id="productBarcode" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù…Ø³Ø­Ù‡"/>
          </div>
        </div>
        <div id="nameError" class="text-danger text-sm mt-2" style="display:none;">âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹</div>
        <div style="display:flex;gap:12px;margin-top:20px;">
          <button class="btn btn-success" onclick="saveProduct()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
          <button class="btn btn-secondary" onclick="clearProductForm()">ğŸ—‘ï¸ ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        </div>
      </div>
    </div>

    <!-- TAB: Families -->
    <div class="tab-content" id="tab-families">
      <div class="card">
        <h3 style="color:var(--primary-light);margin-bottom:16px;">ğŸ·ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª</h3>
        <div style="display:flex;gap:10px;margin-bottom:20px;">
          <input class="input-field" type="text" id="familyInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© (Ù…Ø«Ø§Ù„: Ù…Ø´Ø±ÙˆØ¨Ø§ØªØŒ Ø­Ù„ÙˆÙŠØ§Øª...)" style="flex:1;"/>
          <button class="btn btn-primary" onclick="addFamily()">â• Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div id="familiesList" style="display:flex;flex-wrap:wrap;gap:10px;"></div>
      </div>
    </div>

    <!-- TAB: Import/Export -->
    <div class="tab-content" id="tab-import">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;">
        <!-- Import -->
        <div class="card">
          <h3 style="color:var(--primary-light);margin-bottom:16px;">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
          <p class="text-muted text-sm mb-3">Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ CSV Ø«Ù… Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ø¨Ø£.</p>
          <label style="display:block;background:var(--bg-input);border:2px dashed var(--border);border-radius:var(--radius);padding:30px;text-align:center;cursor:pointer;transition:var(--transition);" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
            <div style="font-size:2rem;">ğŸ“‚</div>
            <div style="color:var(--text-secondary);margin-top:8px;font-size:0.9rem;">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù CSV</div>
            <input type="file" accept=".csv" id="importFile" style="display:none;" onchange="handleImport(this)"/>
          </label>
          <div id="importProgress" class="mt-3" style="display:none;"></div>
        </div>
        <!-- Export -->
        <div class="card">
          <h3 style="color:var(--primary-light);margin-bottom:16px;">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
          <p class="text-muted text-sm mb-3">ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ ÙØ§Ø±Øº.</p>
          <button class="btn btn-primary btn-full mb-3" onclick="exportProducts()">ğŸ“¥ ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (CSV)</button>
          <button class="btn btn-secondary btn-full" onclick="downloadCSVTemplate()">ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ CSV</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Import Modal -->
<div class="modal-overlay" id="importConfirmModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</span>
      <button class="modal-close" onclick="closeModal('importConfirmModal')">âœ•</button>
    </div>
    <div id="importConflicts"></div>
    <div class="modal-footer">
      <button class="btn btn-success" onclick="confirmImport(true)">âœ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn btn-secondary" onclick="confirmImport(false)">â­ï¸ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø¨Ù‡Ø©</button>
      <button class="btn btn-danger" onclick="closeModal('importConfirmModal')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Sidebar â€” labels only, no icons -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-brand">POS DZ</div>
    <div class="sidebar-user" id="sidebarUser"></div>
  </div>
  <nav class="sidebar-nav">
    <a class="nav-item" href="sale.html">
      <span class="nav-label" data-nav="navSale">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹</span>
    </a>
    <a class="nav-item" href="inventory.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navInventory">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
    </a>
    <a class="nav-item" href="customers.html" data-role="admin,manager,seller">
      <span class="nav-label" data-nav="navCustomers">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</span>
    </a>
    <a class="nav-item" href="reports.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navReports">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</span>
    </a>
    <a class="nav-item" href="users.html" data-role="admin">
      <span class="nav-label" data-nav="navUsers">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
    </a>
    <a class="nav-item" href="suppliers.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navSuppliers">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ²Ø¹ÙŠÙ†</span>
    </a>
    <a class="nav-item" href="settings.html" data-role="admin,manager">
      <span class="nav-label" data-nav="navSettings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</span>
    </a>
    <div class="nav-item danger" onclick="doLogout()">
      <span class="nav-label" data-nav="navLogout">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
    </div>
  </nav>
  <div class="sidebar-footer">POS DZ v6.0.0 | 2026 Ø¨ÙˆØ³ Ø¯ÙŠØ²Ø§Ø¯ Â®</div>
</div>
<div id="toast-container"></div>
<script src="app.js"></script>
<script>
let allProducts = [];
let allFamilies = [];
let importData = [];
let currency = 'DA';

async function init() {
  requireRole(['admin', 'manager']);
  await initApp();
  currency = await getSetting('currency') || 'DA';
  await loadFamilies();
  await loadProducts();
  await checkAlerts();
  // Enter ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù… ÙŠØ­Ø±Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â€” Enter ÙÙŠ Ø¢Ø®Ø± Ø­Ù‚Ù„ ÙŠØ­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬
  document.getElementById('productName')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); document.getElementById('productSize')?.focus(); }
  });
  document.getElementById('productSize')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); document.getElementById('productBarcode')?.focus(); }
  });
  document.getElementById('productBarcode')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); saveProduct(); }
  });
  document.getElementById('productSearch')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); filterProducts(); }
  });
  document.getElementById('familyInput')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); saveFamily(); }
  });
}

function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  const tabs = ['all','add','families','import'];
  const idx = tabs.indexOf(name);
  document.querySelectorAll('.tab-btn')[idx]?.classList.add('active');
  document.getElementById('tab-' + name)?.classList.add('active');
  if (name === 'all') loadProducts();
  if (name === 'families') renderFamilies();
}

// â”€â”€ Alerts â”€â”€
async function checkAlerts() {
  const products = await dbGetAll('products');
  const lowStock = await getSetting('lowStockAlert') || 5;
  const expiryDays = await getSetting('expiryAlertDays') || 30;
  const now = new Date();
  const alerts = [];
  products.forEach(p => {
    if (p.quantity <= lowStock) alerts.push(`ğŸ“¦ <b>${p.name}</b> â€” Ø¨Ù‚ÙŠ ${p.quantity} ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†`);
    if (p.expiryDate) {
      const diff = Math.ceil((new Date(p.expiryDate) - now) / 86400000);
      if (diff <= expiryDays && diff > 0) alerts.push(`â³ <b>${p.name}</b> â€” ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ ${diff} ÙŠÙˆÙ…`);
      if (diff <= 0) alerts.push(`âŒ <b>${p.name}</b> â€” Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡!`);
    }
  });
  if (alerts.length) {
    document.getElementById('alertsBox').style.display = 'block';
    document.getElementById('alertsList').innerHTML = alerts.map(a => `<div class="alert-item">â€¢ ${a}</div>`).join('');
  }
}

// â”€â”€ Products â”€â”€
async function loadProducts() {
  allProducts = await dbGetAll('products');
  renderProducts(allProducts);
}

function renderProducts(products) {
  const tbody = document.getElementById('productsTbody');
  const now = new Date();
  if (!products.length) {
    tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><div class="empty-icon">ğŸ“¦</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p></td></tr>';
    return;
  }
  tbody.innerHTML = products.map(p => {
    const family = allFamilies.find(f => f.id === p.familyId);
    let stockClass = p.quantity > 10 ? 'stock-ok' : p.quantity > 0 ? 'stock-low' : 'stock-out';
    let expiryInfo = '';
    let alertBadge = '';
    if (p.expiryDate) {
      const diff = Math.ceil((new Date(p.expiryDate) - now) / 86400000);
      expiryInfo = formatDate(p.expiryDate + 'T00:00:00');
      if (diff <= 30 && diff > 0) alertBadge = `<span class="badge badge-warning">â³ ${diff} ÙŠÙˆÙ…</span>`;
      if (diff <= 0) alertBadge = `<span class="badge badge-danger">âŒ Ù…Ù†ØªÙ‡ÙŠ</span>`;
    }
    return `<tr>
      <td><b>${p.name}</b><br><small class="text-muted">${p.barcode || ''} ${p.size || ''}</small></td>
      <td>${family ? family.name : 'â€”'}</td>
      <td>${p.unit || 'â€”'}</td>
      <td>${p.buyPrice || 0} ${currency}</td>
      <td><b>${p.sellPrice || 0} ${currency}</b></td>
      <td><span class="stock-badge ${stockClass}">${p.quantity}</span></td>
      <td>${expiryInfo || 'â€”'}</td>
      <td>${alertBadge}</td>
      <td class="actions">
        <button class="btn btn-sm btn-secondary" title="Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„ØµÙ‚ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" onclick="printBarcodeLabel(${JSON.stringify(p).replace(/"/g,'&quot;')})">ğŸ–¨ï¸</button>
        <button class="btn btn-sm btn-primary" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬" onclick="editProduct(${p.id})">âœï¸</button>
        <button class="btn btn-sm btn-danger" title="Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬" onclick="deleteProduct(${p.id})">ğŸ—‘ï¸</button>
      </td>
    </tr>`;
  }).join('');
}

function filterProducts() {
  const q = document.getElementById('productSearch').value.toLowerCase();
  const filtered = allProducts.filter(p => p.name.toLowerCase().includes(q) || (p.barcode || '').includes(q));
  renderProducts(filtered);
}

// â”€â”€ Save Product â”€â”€
async function saveProduct() {
  const id = document.getElementById('editProductId').value;
  const name = document.getElementById('productName').value.trim();
  if (!name) { toast('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø·Ù„ÙˆØ¨', 'warning'); return; }

  // Check duplicate name
  const all = await dbGetAll('products');
  const dup = all.find(p => p.name === name && p.id !== parseInt(id));
  if (dup) {
    document.getElementById('nameError').style.display = 'block';
    return;
  }
  document.getElementById('nameError').style.display = 'none';

  const familyId = parseInt(document.getElementById('productFamily').value) || null;
  const product = {
    familyId, name,
    barcode: document.getElementById('productBarcode').value.trim(),
    size: document.getElementById('productSize').value.trim(),
    unit: document.getElementById('productUnit').value,
    buyPrice: parseFloat(document.getElementById('productBuyPrice').value) || 0,
    sellPrice: parseFloat(document.getElementById('productSellPrice').value) || 0,
    quantity: parseInt(document.getElementById('productQty').value) || 0,
    expiryDate: document.getElementById('productExpiry').value || null,
    createdAt: new Date().toISOString()
  };

  if (id) { product.id = parseInt(id); await dbPut('products', product); toast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ âœ…', 'success'); }
  else { await dbAdd('products', product); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ âœ…', 'success'); }

  clearProductForm();
  switchTab('all');
}

function clearProductForm() {
  ['editProductId','productName','productBarcode','productSize','productBuyPrice','productSellPrice','productQty','productExpiry'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('productFamily').value = '';
  document.getElementById('productUnit').value = 'Ù‚Ø·Ø¹Ø©';
  document.getElementById('formTitle').textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯';
  document.getElementById('nameError').style.display = 'none';
}

async function editProduct(id) {
  const p = await dbGet('products', id);
  if (!p) return;
  switchTab('add');
  document.getElementById('editProductId').value = p.id;
  document.getElementById('productName').value = p.name;
  document.getElementById('productBarcode').value = p.barcode || '';
  document.getElementById('productSize').value = p.size || '';
  document.getElementById('productUnit').value = p.unit || 'Ù‚Ø·Ø¹Ø©';
  document.getElementById('productBuyPrice').value = p.buyPrice || '';
  document.getElementById('productSellPrice').value = p.sellPrice || '';
  document.getElementById('productQty').value = p.quantity || '';
  document.getElementById('productExpiry').value = p.expiryDate || '';
  document.getElementById('productFamily').value = p.familyId || '';
  document.getElementById('formTitle').textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬';
}

async function deleteProduct(id) {
  if (!await customConfirmAsync('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
  await dbDelete('products', id);
  toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', 'success');
  loadProducts();
}

// â”€â”€ Families â”€â”€
async function loadFamilies() {
  allFamilies = await dbGetAll('families');
  const sel = document.getElementById('productFamily');
  sel.innerHTML = '<option value="">-- Ø¨Ø¯ÙˆÙ† Ø¹Ø§Ø¦Ù„Ø© --</option>';
  allFamilies.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f.id; opt.textContent = f.name;
    sel.appendChild(opt);
  });
}

function renderFamilies() {
  const container = document.getElementById('familiesList');
  container.innerHTML = allFamilies.map(f => `
    <div style="display:flex;align-items:center;gap:8px;background:var(--bg-card);border:1px solid var(--border);padding:8px 14px;border-radius:20px;">
      <span>${f.name}</span>
      <button class="btn btn-sm btn-danger btn-icon" onclick="deleteFamily(${f.id})">âœ•</button>
    </div>`).join('');
}

async function addFamily() {
  const name = document.getElementById('familyInput').value.trim();
  if (!name) return;
  try {
    await dbAdd('families', { name });
    document.getElementById('familyInput').value = '';
    allFamilies = await dbGetAll('families');
    renderFamilies();
    loadFamilies();
    toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©', 'success');
  } catch(e) { toast('Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'warning'); }
}

async function deleteFamily(id) {
  if (!await customConfirmAsync('Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©ØŸ')) return;
  await dbDelete('families', id);
  allFamilies = await dbGetAll('families');
  renderFamilies(); loadFamilies();
}

// â”€â”€ Import â”€â”€
async function handleImport(input) {
  const file = input.files[0];
  if (!file) return;
  importCSV(file, async (data) => {
    const products = await dbGetAll('products');
    const conflicts = data.filter(row => products.find(p => p.name === row.name));
    importData = data;
    if (conflicts.length) {
      document.getElementById('importConflicts').innerHTML =
        `<p class="text-warning mb-3">âš ï¸ ÙˆÙØ¬Ø¯ ${conflicts.length} Ù…Ù†ØªØ¬ Ù…Ø´Ø§Ø¨Ù‡:</p>` +
        conflicts.map(c => `<div class="alert-item">â€¢ ${c.name}</div>`).join('');
      openModal('importConfirmModal');
    } else {
      await doImport(data, false);
    }
  });
}

async function confirmImport(update) {
  closeModal('importConfirmModal');
  await doImport(importData, update);
}

async function doImport(data, update) {
  let added = 0, updated = 0, skipped = 0;
  const existing = await dbGetAll('products');
  for (const row of data) {
    if (!row.name) continue;
    const found = existing.find(p => p.name === row.name);
    const families = await dbGetAll('families');
    let familyId = null;
    if (row.family) {
      let fam = families.find(f => f.name === row.family);
      if (!fam) { const fid = await dbAdd('families', { name: row.family }); familyId = fid; }
      else familyId = fam.id;
    }
    const product = {
      familyId, name: row.name,
      barcode: row.barcode || '',
      size: row.size || '',
      unit: row.unit || 'Ù‚Ø·Ø¹Ø©',
      buyPrice: parseFloat(row.buy_price) || 0,
      sellPrice: parseFloat(row.sell_price) || 0,
      quantity: parseInt(row.quantity) || 0,
      expiryDate: row.expiry_date || null,
      createdAt: new Date().toISOString()
    };
    if (found) {
      if (update) { product.id = found.id; await dbPut('products', product); updated++; }
      else skipped++;
    } else {
      await dbAdd('products', product); added++;
    }
  }
  toast(`âœ… Ù…ÙØ¶Ø§Ù: ${added} | Ù…Ø­Ø¯Ù‘Ø«: ${updated} | Ù…ØªØ¬Ø§Ù‡Ù„: ${skipped}`, 'success', 4000);
  await loadProducts();
}

async function exportProducts() {
  const products = await dbGetAll('products');
  const data = products.map(p => ({
    name: p.name, barcode: p.barcode || '', size: p.size || '',
    unit: p.unit, buy_price: p.buyPrice, sell_price: p.sellPrice,
    quantity: p.quantity, expiry_date: p.expiryDate || ''
  }));
  exportCSV(data, 'products_export.csv');
}

function doLogout() { customConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ', () => { clearSession(); window.location.href = 'index.html'; }); }
init();
</script>
</body>
</html>
